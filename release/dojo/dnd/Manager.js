//>>built
define("dojo/dnd/Manager",["../_base/array","../_base/connect","../_base/declare","../_base/event","../_base/window","../dom-class","../Evented","../keys","../topic","./common","./autoscroll","./Avatar"],function(k,d,l,j,c,g,m,h,e,f,n,o){var i=l("dojo.dnd.Manager",[m],{constructor:function(){this.source=this.avatar=null;this.nodes=[];this.copy=!0;this.target=null;this.canDropFlag=!1;this.events=[]},OFFSET_X:16,OFFSET_Y:16,overSource:function(a){if(this.avatar)this.target=a&&a.targetState!="Disabled"?
a:null,this.canDropFlag=Boolean(this.target),this.avatar.update();e.publish("/dnd/source/over",a)},outSource:function(a){if(this.avatar){if(this.target==a)this.target=null,this.canDropFlag=!1,this.avatar.update(),e.publish("/dnd/source/over",null)}else e.publish("/dnd/source/over",null)},startDrag:function(a,b,f){this.source=a;this.nodes=b;this.copy=Boolean(f);this.avatar=this.makeAvatar();c.body().appendChild(this.avatar.node);e.publish("/dnd/start",a,b,this.copy);this.events=[d.connect(c.doc,"onmousemove",
this,"onMouseMove"),d.connect(c.doc,"onmouseup",this,"onMouseUp"),d.connect(c.doc,"onkeydown",this,"onKeyDown"),d.connect(c.doc,"onkeyup",this,"onKeyUp"),d.connect(c.doc,"ondragstart",j.stop),d.connect(c.body(),"onselectstart",j.stop)];g.add(c.body(),"dojoDnd"+(f?"Copy":"Move"))},canDrop:function(a){a=Boolean(this.target&&a);if(this.canDropFlag!=a)this.canDropFlag=a,this.avatar.update()},stopDrag:function(){g.remove(c.body(),["dojoDndCopy","dojoDndMove"]);k.forEach(this.events,d.disconnect);this.events=
[];this.avatar.destroy();this.source=this.target=this.avatar=null;this.nodes=[]},makeAvatar:function(){return new o(this)},updateAvatar:function(){this.avatar.update()},onMouseMove:function(a){var b=this.avatar;if(b)n.autoScrollNodes(a),b=b.node.style,b.left=a.pageX+this.OFFSET_X+"px",b.top=a.pageY+this.OFFSET_Y+"px",a=Boolean(this.source.copyState(d.isCopyKey(a))),this.copy!=a&&this._setCopyStatus(a)},onMouseUp:function(a){if(this.avatar){if(this.target&&this.canDropFlag){var b=Boolean(this.source.copyState(dojo.isCopyKey(a)));
e.publish("/dnd/drop/before",this.source,this.nodes,b,this.target,a);e.publish("/dnd/drop",this.source,this.nodes,b,this.target,a)}else e.publish("/dnd/cancel");this.stopDrag()}},onKeyDown:function(a){if(this.avatar)switch(a.keyCode){case h.CTRL:a=Boolean(this.source.copyState(!0));this.copy!=a&&this._setCopyStatus(a);break;case h.ESCAPE:e.publish("/dnd/cancel"),this.stopDrag()}},onKeyUp:function(a){this.avatar&&a.keyCode==h.CTRL&&(a=Boolean(this.source.copyState(!1)),this.copy!=a&&this._setCopyStatus(a))},
_setCopyStatus:function(a){this.copy=a;this.source._markDndStatus(this.copy);this.updateAvatar();g.replace(c.body(),"dojoDnd"+(this.copy?"Copy":"Move"),"dojoDnd"+(this.copy?"Move":"Copy"))}});f._manager=null;i.manager=f.manager=function(){if(!f._manager)f._manager=new i;return f._manager};return i});